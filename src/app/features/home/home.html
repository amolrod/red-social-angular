<div class="home-container">
  
  <mat-card class="new-post-card">
    <h2>¿Qué estás pensando?</h2>
    
    <div class="feed-filter">
      <button 
        mat-stroked-button 
        [color]="showFollowingOnly ? 'primary' : ''"
        (click)="toggleFeedFilter()">
        <mat-icon>{{ showFollowingOnly ? 'people' : 'public' }}</mat-icon>
        {{ showFollowingOnly ? 'Siguiendo' : 'Todos' }}
      </button>
    </div>

    <mat-form-field class="full-width">
      <textarea 
        matInput 
        [(ngModel)]="newPostContent" 
        placeholder="Escribe algo..."
        rows="3">
      </textarea>
    </mat-form-field>
    
    <button 
      mat-raised-button 
      color="primary" 
      (click)="createPost()"
      [disabled]="isLoading || !newPostContent.trim()">
      <mat-icon>send</mat-icon>
      {{ isLoading ? 'Publicando...' : 'Publicar' }}
    </button>
  </mat-card>

  <div class="posts-feed">
    
    <div *ngIf="(posts$ | async)?.length === 0" class="no-posts">
      <mat-icon>post_add</mat-icon>
      <p>No hay posts para mostrar</p>
      <p class="subtitle" *ngIf="showFollowingOnly">
        Aún no sigues a nadie o no han publicado nada
      </p>
    </div>

    <mat-card *ngFor="let post of posts$ | async" class="post-card">
      <mat-card-header>
        <div mat-card-avatar class="post-avatar">
          <mat-icon>account_circle</mat-icon>
        </div>
        <mat-card-title>
          <span 
            class="author-name" 
            [class.clickable]="!isOwnPost(post.authorId)"
            (click)="!isOwnPost(post.authorId) && viewUserProfile(post.authorId)">
            {{ post.authorEmail }}
          </span>
          <span class="own-post-badge" *ngIf="isOwnPost(post.authorId)">Tú</span>
        </mat-card-title>
        <mat-card-subtitle>{{ getPostDate(post.createdAt) | date:'short' }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <p class="post-content">{{ post.content }}</p>
      </mat-card-content>

      <mat-card-actions>
        <button 
          mat-button 
          (click)="toggleLike(post)"
          [class.liked]="hasLiked(post)">
          <mat-icon>{{ hasLiked(post) ? 'favorite' : 'favorite_border' }}</mat-icon>
          <span>{{ post.likes }}</span>
        </button>

        <button 
          mat-button 
          (click)="toggleComments(post.id)"
          [class.active]="isCommentsExpanded(post.id)">
          <mat-icon>comment</mat-icon>
          <span>{{ post.comments.length || 0 }}</span>
        </button>

        <span class="spacer"></span>

        <button 
          *ngIf="isOwnPost(post.authorId)"
          mat-icon-button 
          color="warn"
          (click)="deletePost(post.id, post.authorId)">
          <mat-icon>delete</mat-icon>
        </button>
      </mat-card-actions>

      <div *ngIf="isCommentsExpanded(post.id)" class="comments-section">
        <div class="comments-list" *ngIf="post.comments && post.comments.length > 0">
          <div *ngFor="let comment of post.comments" class="comment-item">
            <div class="comment-avatar">
              <mat-icon>account_circle</mat-icon>
            </div>
            <div class="comment-content">
              <div class="comment-header">
                <span class="comment-author">{{ comment.authorEmail }}</span>
                <span class="comment-date">{{ getCommentDate(comment.createdAt) | date:'short' }}</span>
              </div>
              <p class="comment-text">{{ comment.content }}</p>
            </div>
          </div>
        </div>

        <div class="no-comments" *ngIf="!post.comments || post.comments.length === 0">
          No hay comentarios aún. ¡Sé el primero en comentar!
        </div>

        <div class="new-comment-form">
          <mat-form-field class="full-width">
            <input 
              matInput 
              [value]="getNewCommentText(post.id)"
              (input)="setNewCommentText(post.id, $any($event.target).value)"
              placeholder="Escribe un comentario..."
              (keyup.enter)="addComment(post.id)">
          </mat-form-field>
          <button 
            mat-mini-fab 
            color="primary"
            (click)="addComment(post.id)"
            [disabled]="!getNewCommentText(post.id) || !getNewCommentText(post.id).trim()">
            <mat-icon>send</mat-icon>
          </button>
        </div>
      </div>

    </mat-card>
  </div>

</div>
