<div class="home-container">
  
  <!-- Formulario para nuevo post -->
  <mat-card class="new-post-card">
    <mat-card-content>
      <h2>¿Qué estás pensando?</h2>
      <mat-form-field appearance="outline" class="full-width">
        <textarea 
          matInput 
          [(ngModel)]="newPostContent"
          placeholder="Escribe algo..."
          rows="3"
          maxlength="500"
          [disabled]="isLoading"></textarea>
        <mat-hint align="end">{{ newPostContent.length }}/500</mat-hint>
      </mat-form-field>
      <button 
        mat-raised-button 
        color="primary" 
        (click)="createPost()"
        [disabled]="!newPostContent.trim() || isLoading">
        <mat-icon>send</mat-icon>
        {{ isLoading ? 'Publicando...' : 'Publicar' }}
      </button>
    </mat-card-content>
  </mat-card>

  <!-- Feed de posts -->
  <div class="posts-feed">
    <mat-card *ngFor="let post of posts$ | async" class="post-card">
      
      <!-- Header del post -->
      <mat-card-header>
        <div mat-card-avatar class="post-avatar">
          <mat-icon>account_circle</mat-icon>
        </div>
        <mat-card-title>
          {{ post.authorEmail }}
          <span class="own-post-badge" *ngIf="isOwnPost(post.authorId)">Tú</span>
        </mat-card-title>
        <mat-card-subtitle>
          {{ getPostDate(post.createdAt) | date:'short' }}
        </mat-card-subtitle>
      </mat-card-header>

      <!-- Contenido del post -->
      <mat-card-content>
        <p class="post-content">{{ post.content }}</p>
      </mat-card-content>

      <mat-divider></mat-divider>

      <!-- Acciones del post -->
      <mat-card-actions>
        <button 
          mat-button 
          (click)="toggleLike(post)"
          [class.liked]="hasLiked(post)">
          <mat-icon [color]="hasLiked(post) ? 'warn' : ''">
            {{ hasLiked(post) ? 'favorite' : 'favorite_border' }}
          </mat-icon>
          <span>{{ post.likes }}</span>
        </button>
        
        <button 
          mat-button 
          (click)="toggleComments(post.id)"
          [class.active]="isCommentsExpanded(post.id)">
          <mat-icon>comment</mat-icon>
          <span>{{ (post.comments || []).length }}</span>
        </button>

        <span class="spacer"></span>

        <button 
          mat-icon-button 
          color="warn" 
          (click)="deletePost(post.id, post.authorId)"
          *ngIf="isOwnPost(post.authorId)"
          matTooltip="Eliminar post">
          <mat-icon>delete</mat-icon>
        </button>
      </mat-card-actions>

      <!-- Sección de comentarios (expandible) -->
      <div class="comments-section" *ngIf="isCommentsExpanded(post.id)">
        <mat-divider></mat-divider>

        <!-- Lista de comentarios -->
        <div class="comments-list" *ngIf="(post.comments || []).length > 0">
          <div *ngFor="let comment of post.comments" class="comment-item">
            <div class="comment-avatar">
              <mat-icon>account_circle</mat-icon>
            </div>
            <div class="comment-content">
              <div class="comment-header">
                <span class="comment-author">{{ comment.authorEmail }}</span>
                <span class="comment-date">{{ getCommentDate(comment.createdAt) | date:'short' }}</span>
              </div>
              <p class="comment-text">{{ comment.content }}</p>
            </div>
          </div>
        </div>

        <!-- Mensaje si no hay comentarios -->
        <div class="no-comments" *ngIf="(post.comments || []).length === 0">
          <p>No hay comentarios aún. ¡Sé el primero en comentar!</p>
        </div>

        <!-- Formulario para nuevo comentario -->
        <div class="new-comment-form">
          <mat-form-field appearance="outline" class="full-width">
            <textarea 
              matInput 
              [value]="getNewCommentText(post.id)"
              (input)="setNewCommentText(post.id, $any($event.target).value)"
              placeholder="Escribe un comentario..."
              rows="2"
              maxlength="300"></textarea>
            <mat-hint align="end">{{ getNewCommentText(post.id).length }}/300</mat-hint>
          </mat-form-field>
          <button 
            mat-raised-button 
            color="primary" 
            (click)="addComment(post.id)"
            [disabled]="!getNewCommentText(post.id).trim()">
            <mat-icon>send</mat-icon>
            Comentar
          </button>
        </div>
      </div>

    </mat-card>

    <!-- Mensaje si no hay posts -->
    <div *ngIf="(posts$ | async)?.length === 0" class="no-posts">
      <mat-icon>chat_bubble_outline</mat-icon>
      <p>No hay posts aún.</p>
      <p class="subtitle">¡Sé el primero en publicar algo!</p>
    </div>
  </div>

</div>
